<!-- Chat Widget Flutuante -->
<div id="chatWidget" style="position: fixed; bottom: 24px; right: 24px; z-index: 9999;">
    <button id="chatToggle" style="background: #6366f1; color: #fff; border-radius: 50%; width: 56px; height: 56px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 2rem; cursor: pointer;">
        ðŸ’¬
    </button>
    <div id="chatBox" style="display: none; width: 340px; background: #fff; border-radius: 12px; box-shadow: 0 2px 16px rgba(0,0,0,0.15); padding: 16px; margin-top: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <strong style="color: #6366f1;">Chat RÃ¡pido</strong>
            <button onclick="document.getElementById('chatBox').style.display='none'" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">âœ–</button>
        </div>
        <div id="chatMessages" style="height: 180px; overflow-y: auto; background: #f3f4f6; border-radius: 8px; padding: 8px; margin-bottom: 8px; font-size: 0.95rem;">
            <!-- Mensagens do chat serÃ£o exibidas aqui via JS/AJAX -->
        </div>
        <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
            <select id="chatDestinatario" style="flex:1; padding:6px; border-radius:6px; border:1px solid #ccc;">
                <option value="geral">ðŸ“¢ Geral</option>
            </select>
        </div>
        <form id="chatForm" style="display: flex; gap: 8px;">
            <input type="text" id="chatInput" placeholder="Digite sua mensagem..." style="flex:1; padding: 6px; border-radius: 6px; border: 1px solid #ccc;">
            <button type="submit" style="background: #6366f1; color: #fff; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer;">Enviar</button>
        </form>
    </div>
</div>
<script>
    document.getElementById('chatToggle').onclick = function() {
        var box = document.getElementById('chatBox');
        box.style.display = box.style.display === 'none' ? 'block' : 'none';
        if (box.style.display === 'block') {
            carregarMensagens();
        }
    };

    function carregarMensagens() {
        const chatUser = document.getElementById('chatDestinatario').value;
        fetch('/api/chat/mensagens?chat_user=' + encodeURIComponent(chatUser))
            .then(res => res.json())
            .then(msgs => {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                msgs.forEach(msg => {
                    const div = document.createElement('div');
                    div.style.marginBottom = '8px';
                    div.innerHTML = `<strong>${msg.remetente}:</strong> ${msg.mensagem}<br><small>${msg.data_envio}</small>`;
                    chatMessages.appendChild(div);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
    }

    document.getElementById('chatForm').onsubmit = function(e) {
        e.preventDefault();
        const input = document.getElementById('chatInput');
        const mensagem = input.value.trim();
        if (!mensagem) return;
        const destinatario = document.getElementById('chatDestinatario').value;
        fetch('/api/chat/enviar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mensagem, destinatario })
        })
        .then(res => res.json())
        .then(resp => {
            if (resp.success) {
                input.value = '';
                carregarMensagens();
            }
        });
    };

    // Popula o select de destinatÃ¡rios
    function carregarUsuarios() {
        fetch('/api/chat/usuarios')
            .then(res => res.json())
            .then(users => {
                const sel = document.getElementById('chatDestinatario');
                // limpar (mantÃ©m a opÃ§Ã£o 'geral')
                sel.innerHTML = '<option value="geral">ðŸ“¢ Geral</option>';
                users.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.email;
                    opt.text = 'ðŸ‘¤ ' + u.nome;
                    sel.appendChild(opt);
                });
            });
    }

    // Carregar usuÃ¡rios ao abrir o chat
    document.getElementById('chatToggle').addEventListener('click', carregarUsuarios);

    // Atualizar mensagens a cada 10 segundos se o chat estiver aberto
    setInterval(() => {
        var box = document.getElementById('chatBox');
        if (box.style.display === 'block') {
            carregarMensagens();
        }
    }, 10000);
</script>
